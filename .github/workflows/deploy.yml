name: Deploy to CloudBase

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: éƒ¨ç½²å‰åç«¯åˆ° CloudBase

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: å®‰è£… CloudBase CLI
        run: |
          npm install -g @cloudbase/cli@latest
          tcb -v

      - name: æ„å»ºå‰ç«¯
        env:
          NODE_ENV: production
        run: |
          cd frontend
          npm ci --legacy-peer-deps
          npx vite build
          ls -la dist/

      - name: éƒ¨ç½²å‰ç«¯åˆ°é™æ€ç½‘ç«™æ‰˜ç®¡
        env:
          CLOUDBASE_SECRET_ID: ${{ secrets.CLOUDBASE_SECRET_ID }}
          CLOUDBASE_SECRET_KEY: ${{ secrets.CLOUDBASE_SECRET_KEY }}
          TCB_SECRET_ID: ${{ secrets.CLOUDBASE_SECRET_ID }}
          TCB_SECRET_KEY: ${{ secrets.CLOUDBASE_SECRET_KEY }}
          CLOUDBASE_ENV_ID: cloud1-6gt5ulxm10210d0f
        run: |
          echo "ğŸš€ éƒ¨ç½²å‰ç«¯é™æ€æ–‡ä»¶..."
          cd frontend
          tcb hosting deploy dist/ /lead-management --envId $CLOUDBASE_ENV_ID
          echo "âœ… å‰ç«¯éƒ¨ç½²å®Œæˆï¼"

      - name: éƒ¨ç½²åç«¯åˆ°äº‘æ‰˜ç®¡
        env:
          CLOUDBASE_SECRET_ID: ${{ secrets.CLOUDBASE_SECRET_ID }}
          CLOUDBASE_SECRET_KEY: ${{ secrets.CLOUDBASE_SECRET_KEY }}
          TCB_SECRET_ID: ${{ secrets.CLOUDBASE_SECRET_ID }}
          TCB_SECRET_KEY: ${{ secrets.CLOUDBASE_SECRET_KEY }}
          CLOUDBASE_ENV_ID: cloud1-6gt5ulxm10210d0f
        run: |
          echo "ğŸš€ éƒ¨ç½²åç«¯å®¹å™¨æœåŠ¡..."
          echo "Y" | tcb framework deploy --envId $CLOUDBASE_ENV_ID --verbose
          echo "âœ… åç«¯éƒ¨ç½²å®Œæˆï¼"

      - name: éƒ¨ç½²ç»“æœé€šçŸ¥
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "å‰ç«¯åœ°å€: https://cloud1-6gt5ulxm10210d0f-1300255017.tcloudbaseapp.com/lead-management"
            echo "åç«¯åœ°å€: https://lead-management-api-193614-4-1300255017.sh.run.tcloudbase.com"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
          fi
