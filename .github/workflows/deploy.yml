name: Deploy to CloudBase

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: éƒ¨ç½²å‰åŽç«¯åˆ° CloudBase

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: å®‰è£… CloudBase CLI
        run: |
          npm install -g @cloudbase/cli@latest
          tcb -v

      - name: éƒ¨ç½²åˆ° CloudBase
        env:
          CLOUDBASE_SECRET_ID: ${{ secrets.CLOUDBASE_SECRET_ID }}
          CLOUDBASE_SECRET_KEY: ${{ secrets.CLOUDBASE_SECRET_KEY }}
          CLOUDBASE_ENV_ID: cloud1-6gt5ulxm10210d0f
        run: |
          # ä½¿ç”¨çŽ¯å¢ƒå˜é‡æ–¹å¼è®¤è¯ï¼ˆéžäº¤äº’å¼ï¼‰
          echo "é…ç½® CloudBase è®¤è¯ä¿¡æ¯..."
          
          # åˆ›å»ºé…ç½®ç›®å½•
          mkdir -p ~/.cloudbase
          
          # å†™å…¥è®¤è¯é…ç½®
          cat > ~/.cloudbase/config.json << EOF
          {
            "secretId": "$CLOUDBASE_SECRET_ID",
            "secretKey": "$CLOUDBASE_SECRET_KEY",
            "envId": "$CLOUDBASE_ENV_ID"
          }
          EOF
          
          echo "âœ… è®¤è¯é…ç½®å®Œæˆ"
          
          # ç¡®è®¤ç™»å½•çŠ¶æ€
          echo "æ£€æŸ¥çŽ¯å¢ƒä¿¡æ¯..."
          tcb env:list || echo "çŽ¯å¢ƒåˆ—è¡¨èŽ·å–å¤±è´¥ï¼Œç»§ç»­å°è¯•éƒ¨ç½²"
          
          # éƒ¨ç½²å‰åŽç«¯
          echo "å¼€å§‹éƒ¨ç½²é¡¹ç›®..."
          echo "Y" | tcb framework deploy --envId $CLOUDBASE_ENV_ID --verbose
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"

      - name: éƒ¨ç½²ç»“æžœé€šçŸ¥
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ðŸŽ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "å‰ç«¯åœ°å€: https://cloud1-6gt5ulxm10210d0f-1300255017.tcloudbaseapp.com/lead-management"
            echo "åŽç«¯åœ°å€: https://lead-management-api-193614-4-1300255017.sh.run.tcloudbase.com"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
          fi
