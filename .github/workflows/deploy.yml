name: Deploy to CloudBase

on:
  push:
    branches:
      - main
  workflow_dispatch: # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: 部署前后端到 CloudBase

    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 设置 Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: 安装 CloudBase CLI
        run: |
          npm install -g @cloudbase/cli@latest
          tcb -v

      - name: 构建前端
        env:
          NODE_ENV: production
        run: |
          cd frontend
          npm ci --legacy-peer-deps
          npx vite build
          ls -la dist/

      - name: 部署前端到静态网站托管
        env:
          CLOUDBASE_SECRET_ID: ${{ secrets.CLOUDBASE_SECRET_ID }}
          CLOUDBASE_SECRET_KEY: ${{ secrets.CLOUDBASE_SECRET_KEY }}
          TCB_SECRET_ID: ${{ secrets.CLOUDBASE_SECRET_ID }}
          TCB_SECRET_KEY: ${{ secrets.CLOUDBASE_SECRET_KEY }}
          CLOUDBASE_ENV_ID: cloud1-6gt5ulxm10210d0f
        run: |
          echo "🚀 部署前端静态文件..."
          cd frontend
          tcb hosting deploy dist/ /lead-management --envId $CLOUDBASE_ENV_ID
          echo "✅ 前端部署完成！"

      - name: 部署后端到云托管
        env:
          CLOUDBASE_SECRET_ID: ${{ secrets.CLOUDBASE_SECRET_ID }}
          CLOUDBASE_SECRET_KEY: ${{ secrets.CLOUDBASE_SECRET_KEY }}
          TCB_SECRET_ID: ${{ secrets.CLOUDBASE_SECRET_ID }}
          TCB_SECRET_KEY: ${{ secrets.CLOUDBASE_SECRET_KEY }}
          CLOUDBASE_ENV_ID: cloud1-6gt5ulxm10210d0f
        run: |
          echo "🚀 部署后端容器服务..."
          echo "Y" | tcb framework deploy --envId $CLOUDBASE_ENV_ID --verbose
          echo "✅ 后端部署完成！"

      - name: 部署结果通知
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "🎉 部署成功！"
            echo "前端地址: https://cloud1-6gt5ulxm10210d0f-1300255017.tcloudbaseapp.com/lead-management"
            echo "后端地址: https://lead-management-api-193614-4-1300255017.sh.run.tcloudbase.com"
          else
            echo "❌ 部署失败，请查看日志"
          fi
