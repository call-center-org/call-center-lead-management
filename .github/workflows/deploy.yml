name: Deploy to CloudBase

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: éƒ¨ç½²å‰åç«¯åˆ° CloudBase
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: å®‰è£… CloudBase CLI
        run: |
          npm install -g @cloudbase/cli@latest
          tcb -v
      
      - name: éƒ¨ç½²åˆ° CloudBase
        env:
          CLOUDBASE_SECRET_ID: ${{ secrets.CLOUDBASE_SECRET_ID }}
          CLOUDBASE_SECRET_KEY: ${{ secrets.CLOUDBASE_SECRET_KEY }}
        run: |
          # ä½¿ç”¨ SecretId å’Œ SecretKey ç™»å½•
          echo "å¼€å§‹ç™»å½• CloudBase..."
          tcb login --apiKeyId $CLOUDBASE_SECRET_ID --apiKey $CLOUDBASE_SECRET_KEY
          
          # ç¡®è®¤ç™»å½•çŠ¶æ€
          echo "æ£€æŸ¥ç™»å½•çŠ¶æ€..."
          
          # éƒ¨ç½²å‰åç«¯
          echo "å¼€å§‹éƒ¨ç½²é¡¹ç›®..."
          echo "Y" | tcb framework deploy --verbose
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
      
      - name: éƒ¨ç½²ç»“æœé€šçŸ¥
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "å‰ç«¯åœ°å€: https://cloud1-6gt5ulxm10210d0f-1300255017.tcloudbaseapp.com/lead-management"
            echo "åç«¯åœ°å€: https://lead-management-api-193614-4-1300255017.sh.run.tcloudbase.com"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
          fi

