name: Deploy to CloudBase

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: éƒ¨ç½²å‰åç«¯åˆ° CloudBase

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: å®‰è£… CloudBase CLI
        run: |
          npm install -g @cloudbase/cli@latest
          tcb -v

      - name: éƒ¨ç½²åˆ° CloudBase
        env:
          CLOUDBASE_SECRET_ID: ${{ secrets.CLOUDBASE_SECRET_ID }}
          CLOUDBASE_SECRET_KEY: ${{ secrets.CLOUDBASE_SECRET_KEY }}
          TCB_SECRET_ID: ${{ secrets.CLOUDBASE_SECRET_ID }}
          TCB_SECRET_KEY: ${{ secrets.CLOUDBASE_SECRET_KEY }}
          CLOUDBASE_ENV_ID: cloud1-6gt5ulxm10210d0f
        run: |
          # CloudBase CLI é€šè¿‡ç¯å¢ƒå˜é‡è‡ªåŠ¨è®¤è¯
          echo "âœ… å·²é…ç½® CloudBase è®¤è¯ç¯å¢ƒå˜é‡"
          echo "   - TCB_SECRET_ID: ${TCB_SECRET_ID:0:10}..."
          echo "   - ç¯å¢ƒID: $CLOUDBASE_ENV_ID"
          
          # ç¡®è®¤ç¯å¢ƒ
          echo "æ£€æŸ¥å¯ç”¨ç¯å¢ƒ..."
          tcb env:list 2>&1 || echo "âš ï¸ ç¯å¢ƒåˆ—è¡¨è·å–å¤±è´¥ï¼Œä½†å°†ç»§ç»­éƒ¨ç½²"
          
          # éƒ¨ç½²å‰åç«¯
          echo ""
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²é¡¹ç›®åˆ° CloudBase..."
          echo "Y" | tcb framework deploy --envId $CLOUDBASE_ENV_ID --verbose
          
          echo ""
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"

      - name: éƒ¨ç½²ç»“æœé€šçŸ¥
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "å‰ç«¯åœ°å€: https://cloud1-6gt5ulxm10210d0f-1300255017.tcloudbaseapp.com/lead-management"
            echo "åç«¯åœ°å€: https://lead-management-api-193614-4-1300255017.sh.run.tcloudbase.com"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
          fi
